<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="cocoa_chen&#39;s blog">
  <meta name="keyword" content="objective-C, cocoa_chen, Swift">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      AVAudioSession音频配置小技巧 | cocoa_chen
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">

  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  
<script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>

<meta name="generator" content="Hexo 4.2.1"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>cocoa_chen</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>AVAudioSession音频配置小技巧</h2>
  <p class="post-date">2020-08-20</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>iOS在音频配置方面的核心逻辑在AVAudioSession，它用来管理多个App对音频硬件设备（麦克风，扬声器）的资源使用。这篇文章不是AVAudioSession的科普，如果你还不了解它，可以google下，会有很多文章专门介绍它。这里总结一些网络上不常见的音频配置技巧点，帮助你优化App的体验问题。</p>
<p><img src="/images/avaudiosession/15982539026283.jpg" alt=""></p>
<h2 id="技巧点总结"><a href="#技巧点总结" class="headerlink" title="技巧点总结"></a>技巧点总结</h2><h3 id="技巧一：适配蓝牙设备"><a href="#技巧一：适配蓝牙设备" class="headerlink" title="技巧一：适配蓝牙设备"></a>技巧一：适配蓝牙设备</h3><p><strong>背景：</strong></p>
<p>在录音时，我们常会使用下面的代码来支持蓝牙设备，但是这样适配的方案有问题。在一些蓝牙设备或者汽车的车载蓝牙音箱上会出现录音被识别为电话优先级的事情出现，无法使用车载的FM，音乐播放也会出现音质变差的问题，用户体验极差。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayAndRecord withOptions:AVAudioSessionCategoryOptionMixWithOthers | AVAudioSessionCategoryOptionAllowBluetooth error:nil];</span><br></pre></td></tr></table></figure>

<p><strong>问题原因：</strong></p>
<p>为了解决这个问题，我们首先需要了解下蓝牙协议的三大规格：HSP、HFP和A2DP</p>
<blockquote>
<p>HeadsetPro-file（HSP）代表耳机功能，提供手机与耳机之间通信所需的基本功能。<br>HandProfile（HFP）则代表免提功能，HFP在HSP的基础上增加了某些扩展功能。<br>Advanced Audio Distribution Profile（A2DP），指的是蓝牙音频传输模型协定。<br>HFP格式的蓝牙耳机支持手机功能比较完整，消费者可在耳机上操作手机设定好的重拨、来电保留、来电拒听等免提选项功能。<br>A2DP是高级音频传送规格，允许传输立体声音频信号，相比用于 HSP 和 HFP 的单声道加密，质量要好得多。</p>
</blockquote>
<p>在录音时，AVAudioSessionCategoryOptionAllowBluetooth会让配对的HFP蓝牙设备作为音频输入源，由于苹果的设定，如果采用了HFP来进行音频输入，那么输出会自动切回为HFP。导致车载中控成为了一个免提设备，同时在进行音频输入和输出，中控台也一直显示拨打电话的界面，也间接导致了FM功能的不可用。</p>
<p>相关内容可参见苹果的官方文档描述，如下：</p>
<blockquote>
<p>AVAudioSessionCategoryOptionAllowBluetooth –<br>This allows an application to change the default behaviour of some audio session categories with regards to showing<br>bluetooth Hands-Free Profile (HFP) devices as available routes. The current category behavior is:<br>(1) AVAudioSessionCategoryPlayAndRecord<br>this will default to false, but can be set to true. This will allow a paired bluetooth HFP device to show up as<br>an available route for input, while playing through the category-appropriate output</p>
</blockquote>
<blockquote>
<p>“If an application uses the setPreferredInput:error: method to select a Bluetooth HFP input, the output will automatically be changed to the Bluetooth HFP output. Moreover, selecting a Bluetooth HFP output using the MPVolumeView’s route picker will automatically change the input to the Bluetooth HFP input. Therefore both the input and output will always end up on the Bluetooth HFP device even though only the input or output was set individually.”</p>
</blockquote>
<p><strong>解决方案：</strong></p>
<p>修改AVAudioSession的音频配置为AVAudioSessionCategoryOptionAllowBluetoothA2DP，系统会使音频输出通道切换为A2DP的蓝牙设备，同时将输入切换到最适合音频Category的通道（基本都是内置的麦克风），这样可以将音频输入输出通道作区分，解决上面提到的车载蓝牙设备适配问题。</p>
<p>同时由于蓝牙输入设备的限制,采用HFP蓝牙传输协议时，音频将以8000 Hz的频率单声道播放；而对于支持A2DP的已连接设备，采用A2DP协议可以44100 Hz采样率立体声播放，在将音频输出时的蓝牙传输协议从HFP切换到A2DP后，音质会更好，体验也更佳。</p>
<blockquote>
<p><strong>注意：</strong> AVAudioSessionCategoryOptionAllowBluetooth 和 AVAudioSessionCategoryOptionAllowBluetoothA2DP 可以同时设置。如果有些设备同时支持 HFP 和 A2DP，在两个Option都设置的情况下，HFP port会有更高的优先级。在我们上述的情景下，不能同时设置AllowBluetooth及AllowBluetoothA2DP，不然A2DP会自动失效导致解决方案无效。</p>
</blockquote>
<p>相关内容可参见苹果的官方文档描述，如下：</p>
<blockquote>
<p>AVAudioSessionCategoryOptionAllowBluetoothA2DP –<br>This allows an application to change the default behaviour of some audio session categories with regards to showing<br>bluetooth Advanced Audio Distribution Profile (A2DP), i.e. stereo Bluetooth, devices as available routes. The current<br>category behavior is:<br>(1) AVAudioSessionCategoryPlayAndRecord<br>this will default to false, but can be set to true. This will allow a paired bluetooth A2DP device to show up as<br>an available route for output, while recording through the category-appropriate input</p>
</blockquote>
<p>最终的适配代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (@available(iOS 10.0, *)) &#123;</span><br><span class="line">    [[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayAndRecord withOptions:AVAudioSessionCategoryOptionMixWithOthers | AVAudioSessionCategoryOptionAllowBluetoothA2DP error:nil];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    [[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayAndRecord withOptions:AVAudioSessionCategoryOptionMixWithOthers | AVAudioSessionCategoryOptionAllowBluetooth error:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="技巧二：Carplay支持"><a href="#技巧二：Carplay支持" class="headerlink" title="技巧二：Carplay支持"></a>技巧二：Carplay支持</h3><p>随着车企对Carplay的陆续支持，越来越多的用户开始使用Carplay功能，在音频播报时我们可以采用以下的代码来适配支持</p>
<blockquote>
<p>适配方案可参见官方文档：<a href="https://developer.apple.com/carplay/documentation/CarPlay-Navigation-App-Programming-Guide.pdf" target="_blank" rel="noopener">https://developer.apple.com/carplay/documentation/CarPlay-Navigation-App-Programming-Guide.pdf</a> </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (@available(iOS 12.0, *)) &#123;</span><br><span class="line">    if([AVAudioSession sharedInstance].category &#x3D;&#x3D; AVAudioSessionCategoryPlayback &amp;&amp;</span><br><span class="line">       [[AVAudioSession sharedInstance] mode] !&#x3D; AVAudioSessionModeVoicePrompt) &#123;</span><br><span class="line">        &#x2F;&#x2F;AVAudioSessionModeVoicePrompt只有在AVAudioSessionCategoryPlayback的类型下才会生效</span><br><span class="line">        [[AVAudioSession sharedInstance] setMode:AVAudioSessionModeVoicePrompt error:nil];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="技巧三：port为空防崩溃"><a href="#技巧三：port为空防崩溃" class="headerlink" title="技巧三：port为空防崩溃"></a>技巧三：port为空防崩溃</h3><p>网络上有些文章在设备断开时会读取之前断开的通道是什么，示例代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@implementation YourClass</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    self &#x3D; [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(p_routeChangeNotification:) name:AVAudioSessionRouteChangeNotification object:nil];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;音频通道发生变化</span><br><span class="line">- (void)p_routeChangeNotification:(NSNotification *)notification &#123;</span><br><span class="line">    NSDictionary *userInfo &#x3D; notification.userInfo;</span><br><span class="line">    AVAudioSessionRouteChangeReason reason &#x3D; [userInfo[AVAudioSessionRouteChangeReasonKey] unsignedIntegerValue];</span><br><span class="line">    if (reason &#x3D;&#x3D; AVAudioSessionRouteChangeReasonOldDeviceUnavailable) &#123;</span><br><span class="line">        AVAudioSessionRouteDescription *previousRoute &#x3D; userInfo[AVAudioSessionRouteChangePreviousRouteKey];</span><br><span class="line">        &#x2F;&#x2F;这里用的是outputs[0]</span><br><span class="line">        AVAudioSessionPortDescription *previousOutput &#x3D; previousRoute.outputs[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但其实以上的代码是有问题的，在某些极端情况outputs的数据不是&gt;=1的，直接用[0]会出现数组越界问题而崩溃。建议改成以下的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AVAudioSessionPortDescription *previousOutput &#x3D; previousRoute.outputs.firstObject;</span><br><span class="line">if (!previousOutput) &#123;</span><br><span class="line">    &#x2F;&#x2F;your logic code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="技巧四：overrideOutputAudioPort"><a href="#技巧四：overrideOutputAudioPort" class="headerlink" title="技巧四：overrideOutputAudioPort"></a>技巧四：overrideOutputAudioPort</h3><p>现在主流的AVAudioSession配置都考虑了对耳机插拔的支持，处理逻辑是在新设备连接时调用[[AVAudioSession sharedInstance] overrideOutputAudioPort:AVAudioSessionPortOverrideNone error:nil]; 在设备断开时调用[[AVAudioSession sharedInstance] overrideOutputAudioPort:AVAudioSessionPortOverrideSpeaker error:nil];</p>
<p>这样的处理简单粗暴，会导致设备断开时输出通道强制路由到扬声器，可能会出现错误路由的问题。可判断下当前通道是否为听筒，如果为听筒再重置到扬声器，如果不是忽略即可。代码示意如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AVAudioSessionRouteDescription *currentRoute &#x3D; [AVAudioSession sharedInstance].currentRoute;</span><br><span class="line">AVAudioSessionPortDescription *port &#x3D; currentRoute.outputs.firstObject;</span><br><span class="line">if (!port) &#123;</span><br><span class="line">   return;</span><br><span class="line">&#125;</span><br><span class="line">if ([port.portType isEqualToString:AVAudioSessionPortBuiltInReceiver]) &#123;</span><br><span class="line">   [[AVAudioSession sharedInstance] overrideOutputAudioPort:AVAudioSessionPortOverrideSpeaker error:nil];</span><br><span class="line">   self.overrideToSpeaker &#x3D; YES;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">   if (self.overrideToSpeaker) &#123;</span><br><span class="line">       self.overrideToSpeaker &#x3D; NO;</span><br><span class="line">       [[AVAudioSession sharedInstance] overrideOutputAudioPort:AVAudioSessionPortOverrideNone error:nil];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="技巧五：录音中震动配置"><a href="#技巧五：录音中震动配置" class="headerlink" title="技巧五：录音中震动配置"></a>技巧五：录音中震动配置</h3><p>在设置Category为AVAudioSessionCategoryPlayAndRecord时，调用震动的代码会不生效。在iOS13系统版本以上，系统添加了新的方法，可以配置录音时支持震动功能来解决。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (@available(iOS 13.0, *)) &#123;</span><br><span class="line">    [[AVAudioSession sharedInstance] setAllowHapticsAndSystemSoundsDuringRecording:YES error:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AVAudioSession是管理音频配置的核心类，官方文档里有很多的细节点供挖掘，这里简单总结一些技巧点，如有内容错误，欢迎指正。</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#iOS" >
    <span class="tag-code">iOS</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    <div class="qrcode">
      <canvas id="share-qrcode"></canvas>
      <p class="notice">扫描二维码，分享此文章</p>
    </div>
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://yoursite.com/2020/08/20/AVAudioSession音频配置小技巧/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "cocoa-chen";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "AVAudioSession音频配置小技巧",
        owner: "cocoa-chen",
        repo: "cocoa-chen.github.io",
        oauth: {
          client_id: "e12c4d16bb2a811822a7",
          client_secret: "8fa9d6ce27d985bc1ed6027ee666305208a5e86e"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2020 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>

  </body>
</html>